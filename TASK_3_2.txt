
psql -U postgres -c '
  CREATE TABLE IF NOT EXISTS ratings (
    userId bigint,
    movieId bigint,
    rating float(25),
    timestamp bigint
  );'

psql -U postgres -c "\\copy ratings FROM '/tmp/data/ratings.csv' DELIMITER ',' CSV HEADER"

psql -U postgres -c "
WITH top_rated as ( 
SELECT
    movieId,
    AVG(rating) as avg_rating
FROM public.ratings
GROUP BY movieId
HAVING COUNT(rating) > 50
ORDER BY avg_rating DESC
LIMIT 150)  
SELECT
    movieId,
    avg_rating
INTO top_rated_tags FROM top_rated
;"

psql -U postgres -c "
\copy (SELECT * FROM top_rated_tags LIMIT 100) TO 'top_rated_tags_file.csv' WITH CSV HEADER DELIMITER as '\t';
"